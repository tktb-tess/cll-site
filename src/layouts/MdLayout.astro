---
import '../styles/globals.css';
import type { ImageMetadata, MarkdownLayoutProps } from 'astro';
import Layout from './Layout.astro';
import Toc from '../components/Toc.astro';
import type { H2Content } from '../components/Toc.astro';
import { Image } from 'astro:assets';

type Props = MarkdownLayoutProps<{
  readonly title: string;
  readonly description?: string;
}>;

const { frontmatter, headings } = Astro.props;
const url = (() => {
  const { url } = Astro.props;
  return url ? url : '/';
})();

const gifs = import.meta.glob('../assets/*.gif', { eager: true }) as Record<
  string,
  ImageMetadata | undefined
>;

const gif = gifs[`../assets/${url.slice(1, -1)}.gif`];
const alt = (() => {
  const numS = url.match(/\d+/)?.[0];
  if (!numS) return;
  const num = Number.parseInt(numS);
  if (!Number.isFinite(num)) return;
  return `The picture for chapter ${num}`;
})();

const contents: H2Content[] = [];
const filtered = headings.filter(({ depth }) => depth < 5);

for (const { depth, text, slug } of filtered) {
  switch (depth) {
    case 2: {
      contents.push({
        text: text,
        url: `${url}#${slug}`,
        h3: [],
      });
      break;
    }
    case 3: {
      if (contents.length === 0) {
        contents.push({
          text: '',
          url: '',
          h3: [],
        });
      }
      const last = contents.at(-1)!;
      last.h3.push({
        text: text,
        url: `${url}#${slug}`,
        h4: [],
      });
      break;
    }
    case 4: {
      if (contents.length === 0) {
        contents.push({
          text: '',
          url: '',
          h3: [],
        });
      }
      const h2last = contents.at(-1)!;
      if (h2last.h3.length === 0) {
        h2last.h3.push({
          text: '',
          url: '',
          h4: [],
        });
      }
      const last = h2last.h3.at(-1)!;
      last.h4.push({
        text,
        url: `${url}#${slug}`,
      });
      break;
    }
    default: {
      throw Error('Unexpected heading', { cause: { depth, text, slug } });
    }
  }
}
---

<Layout title={frontmatter.title} {url}>
  {gif && <Image src={gif} alt={alt ?? 'no data'} />}
  <Toc {contents} />
  <slot />
</Layout>
