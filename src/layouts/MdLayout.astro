---
import '../styles/globals.css';
import type { MarkdownLayoutProps } from 'astro';
import Head from './Head.astro';
import Toc from '../components/Toc.astro';
import type { H2Content } from '../components/Toc.astro';
import { Image } from 'astro:assets';
import Sidemenu from '../components/Sidemenu.astro';

type Props = MarkdownLayoutProps<{
  readonly title: string;
  readonly description?: string;
}>;

const { frontmatter, headings, url = '/' } = Astro.props;

const imgData = await (async () => {
  const str = url.match(/chapter(\d+)/)?.[1] ?? '';
  const num = Number.parseInt(str);
  if (!Number.isFinite(num)) return;
  const img: ImageMetadata = (
    await import(`../assets/chapter${num.toString().padStart(2, '0')}.gif`)
  ).default;
  return { src: img, alt: `The picture for chapter ${num}` } as const;
})();

const contents: H2Content[] = [];
const filtered = headings.filter(({ depth }) => depth < 5);

for (const { depth, text, slug } of filtered) {
  switch (depth) {
    case 2: {
      contents.push({
        text: text,
        url: `${url}#${slug}`,
        h3: [],
      });
      break;
    }
    case 3: {
      if (contents.length === 0) {
        contents.push({
          text: '',
          url: '',
          h3: [],
        });
      }
      const last = contents.at(-1)!;
      last.h3.push({
        text: text,
        url: `${url}#${slug}`,
        h4: [],
      });
      break;
    }
    case 4: {
      if (contents.length === 0) {
        contents.push({
          text: '',
          url: '',
          h3: [],
        });
      }
      const h2last = contents.at(-1)!;
      if (h2last.h3.length === 0) {
        h2last.h3.push({
          text: '',
          url: '',
          h4: [],
        });
      }
      const last = h2last.h3.at(-1)!;
      last.h4.push({
        text,
        url: `${url}#${slug}`,
      });
      break;
    }
    default: {
      throw Error('Unexpected heading', { cause: { depth, text, slug } });
    }
  }
}
---

<Head title={frontmatter.title} {url} description={frontmatter.description}>
  <header class='px-4 my-12'>
    <h1 id='title'>{frontmatter.title}</h1>
  </header>
  <hr />
  <main class='flex flex-col md:flex-row *:min-w-0'>
    <aside class='px-4 md:flex-shrinkable-60'>
      <Sidemenu currentUrl={url} />
    </aside>
    <section class='cbg-bg px-4 md:flex-expand-150'>
      {
        imgData && (
          <Image
            id='top-picture'
            class='my-8'
            src={imgData.src}
            alt={imgData.alt}
          />
        )
      }

      <slot />
    </section>
    <aside class='md:flex-shrinkable-60'>
      <nav></nav>
    </aside>
  </main>
  <hr />
  <footer></footer>
</Head>
